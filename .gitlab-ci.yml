variables:
  IMAGE_TAG: "2020-03-05-3"
  UBOOT_URL: "https://gitlab.denx.de/u-boot/custodians/u-boot-amlogic"
  UBOOT_BRANCH: "u-boot-amlogic-next"
  LINARO_TOOLCHAIN_URL: "https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz"
  BOARDS: "odroid-c2 odroid-n2 p212  s400 p201 p200 u200 libretech-cc libretech-ac khadas-vim khadas-vim2 khadas-vim3 khadas-vim2l nanopi-k2 sei510 sei610"

stages:
  - docker
  - build

build:docker:
  stage: docker
  tags: 
    - docker
  variables:
    DOCKER_HOST: tcp://docker:2375/
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""
  image: docker:stable
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker pull $CI_REGISTRY_IMAGE:$IMAGE_TAG && exit 0 || true
    - docker pull $CI_REGISTRY_IMAGE:latest || true
    - docker build --cache-from $CI_REGISTRY_IMAGE:latest --tag $CI_REGISTRY_IMAGE:$IMAGE_TAG --tag $CI_REGISTRY_IMAGE:latest ./
    - docker push $CI_REGISTRY_IMAGE:$IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE:latest

build:initrd:
  tags: 
    - u-boot
  stage: build
  image: $CI_REGISTRY_IMAGE:$IMAGE_TAG
  
  before_script:
    - "[ -d results ] || mkdir results"
    - "[ -d /tmp/toolchain ] || mkdir -p /tmp/toolchain"
    - git clone $UBOOT_URL --branch=$UBOOT_BRANCH --depth=1 /tmp/u-boot
    - wget -qO- $LINARO_TOOLCHAIN_URL  | tar -xJ --strip-components=1 -C /tmp/toolchain

  script:
    - for board in $BOARDS ; do bash build.sh /tmp/toolchain/bin /tmp/u-boot $board ; done

  after_script:
    - for board in $BOARDS ; do cp /tmp/u-boot/build_$board/u-boot.bin results/u-boot_$board.bin ; done

  artifacts:
    when: always
    paths:
      - results/
